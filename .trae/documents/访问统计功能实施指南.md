# VuePress博客访问统计功能实施指南

## 1. 前期准备

### 1.1 LeanCloud账号注册和配置

1. **注册LeanCloud账号**
   - 访问 [LeanCloud官网](https://www.leancloud.cn/)
   - 注册账号并完成实名认证
   - 创建新应用，选择"开发版"（免费）

2. **获取应用配置**
   ```bash
   # 在LeanCloud控制台获取以下信息：
   App ID: xxxxxxxxxx
   App Key: xxxxxxxxxx
   Server URL: https://xxxxxxxxxx.lc-cn-n1-shared.com
   ```

3. **配置数据存储**
   - 进入"数据存储" > "结构化数据"
   - 创建Class：`PageView` 和 `SiteView`
   - 设置权限：允许所有用户读写

### 1.2 项目依赖安装

```bash
# 安装LeanCloud SDK
npm install leancloud-storage

# 安装工具库
npm install lodash.debounce lodash.throttle
```

## 2. 核心代码实现

### 2.1 创建访问统计服务

**创建文件：`docs/.vuepress/utils/analytics.js`**

```javascript
import AV from 'leancloud-storage'
import debounce from 'lodash.debounce'

class AnalyticsService {
  constructor() {
    this.isInitialized = false
    this.cache = new Map()
    this.viewedPages = new Set()
    this.lastViewTime = new Map()
    this.updateQueue = []
    this.useLocalStorage = false
    
    // 防抖处理批量更新
    this.debouncedFlush = debounce(this.flushUpdates.bind(this), 2000)
  }

  // 初始化LeanCloud
  async init(config) {
    try {
      if (!config || !config.appId || !config.appKey) {
        throw new Error('LeanCloud config is required')
      }

      AV.init({
        appId: config.appId,
        appKey: config.appKey,
        serverURL: config.serverURL
      })

      // 测试连接
      await this.testConnection()
      this.isInitialized = true
      console.log('Analytics service initialized successfully')
    } catch (error) {
      console.warn('Analytics service init failed, fallback to localStorage:', error)
      this.useLocalStorage = true
    }
  }

  // 测试LeanCloud连接
  async testConnection() {
    const TestObject = AV.Object.extend('Test')
    const testObject = new TestObject()
    await testObject.save({ test: true })
    await testObject.destroy()
  }

  // 记录页面访问
  async recordPageView(url, title = '') {
    if (!this.shouldRecord(url)) {
      return
    }

    try {
      if (this.useLocalStorage) {
        this.recordPageViewLocal(url, title)
      } else {
        await this.recordPageViewRemote(url, title)
      }
      
      // 同时记录网站总访问量
      await this.recordSiteView()
    } catch (error) {
      console.error('Failed to record page view:', error)
      // 降级到本地存储
      this.recordPageViewLocal(url, title)
    }
  }

  // 检查是否应该记录访问
  shouldRecord(url) {
    const now = Date.now()
    const lastTime = this.lastViewTime.get(url) || 0
    
    // 同一页面5分钟内不重复统计
    if (now - lastTime < 5 * 60 * 1000) {
      return false
    }
    
    this.lastViewTime.set(url, now)
    return true
  }

  // 远程记录页面访问
  async recordPageViewRemote(url, title) {
    const PageView = AV.Object.extend('PageView')
    const query = new AV.Query('PageView')
    query.equalTo('url', url)
    
    try {
      const existingView = await query.first()
      
      if (existingView) {
        // 更新现有记录
        existingView.increment('views', 1)
        existingView.set('lastView', new Date())
        existingView.set('title', title)
        await existingView.save()
      } else {
        // 创建新记录
        const pageView = new PageView()
        pageView.set('url', url)
        pageView.set('title', title)
        pageView.set('views', 1)
        pageView.set('lastView', new Date())
        await pageView.save()
      }
    } catch (error) {
      console.error('Failed to record page view remotely:', error)
      throw error
    }
  }

  // 本地记录页面访问
  recordPageViewLocal(url, title) {
    const views = JSON.parse(localStorage.getItem('page_views') || '{}')
    views[url] = {
      count: (views[url]?.count || 0) + 1,
      title: title,
      lastView: new Date().toISOString()
    }
    localStorage.setItem('page_views', JSON.stringify(views))
  }

  // 记录网站总访问
  async recordSiteView() {
    const today = new Date().toISOString().split('T')[0]
    
    if (this.useLocalStorage) {
      this.recordSiteViewLocal(today)
    } else {
      await this.recordSiteViewRemote(today)
    }
  }

  // 远程记录网站访问
  async recordSiteViewRemote(date) {
    const SiteView = AV.Object.extend('SiteView')
    const query = new AV.Query('SiteView')
    query.equalTo('date', date)
    
    try {
      const existingView = await query.first()
      
      if (existingView) {
        existingView.increment('todayViews', 1)
        existingView.increment('totalViews', 1)
        existingView.set('lastUpdate', new Date())
        await existingView.save()
      } else {
        // 获取历史总访问量
        const totalQuery = new AV.Query('SiteView')
        totalQuery.descending('createdAt')
        const lastRecord = await totalQuery.first()
        const previousTotal = lastRecord ? lastRecord.get('totalViews') : 0
        
        // 创建今日记录
        const siteView = new SiteView()
        siteView.set('date', date)
        siteView.set('todayViews', 1)
        siteView.set('totalViews', previousTotal + 1)
        siteView.set('lastUpdate', new Date())
        await siteView.save()
      }
    } catch (error) {
      console.error('Failed to record site view remotely:', error)
      throw error
    }
  }

  // 本地记录网站访问
  recordSiteViewLocal(date) {
    const siteViews = JSON.parse(localStorage.getItem('site_views') || '{}')
    
    if (!siteViews[date]) {
      siteViews[date] = { todayViews: 0, totalViews: 0 }
    }
    
    siteViews[date].todayViews += 1
    siteViews[date].totalViews = Object.values(siteViews)
      .reduce((total, day) => total + day.todayViews, 0)
    
    localStorage.setItem('site_views', JSON.stringify(siteViews))
  }

  // 获取页面访问次数
  async getPageViews(url) {
    if (this.cache.has(url)) {
      return this.cache.get(url)
    }
    
    let views = 0
    
    try {
      if (this.useLocalStorage) {
        views = this.getPageViewsLocal(url)
      } else {
        views = await this.getPageViewsRemote(url)
      }
    } catch (error) {
      console.error('Failed to get page views:', error)
      views = this.getPageViewsLocal(url)
    }
    
    this.cache.set(url, views)
    return views
  }

  // 远程获取页面访问次数
  async getPageViewsRemote(url) {
    const PageView = AV.Object.extend('PageView')
    const query = new AV.Query('PageView')
    query.equalTo('url', url)
    
    const pageView = await query.first()
    return pageView ? pageView.get('views') : 0
  }

  // 本地获取页面访问次数
  getPageViewsLocal(url) {
    const views = JSON.parse(localStorage.getItem('page_views') || '{}')
    return views[url]?.count || 0
  }

  // 获取网站总访问次数
  async getSiteViews() {
    try {
      if (this.useLocalStorage) {
        return this.getSiteViewsLocal()
      } else {
        return await this.getSiteViewsRemote()
      }
    } catch (error) {
      console.error('Failed to get site views:', error)
      return this.getSiteViewsLocal()
    }
  }

  // 远程获取网站总访问次数
  async getSiteViewsRemote() {
    const SiteView = AV.Object.extend('SiteView')
    const query = new AV.Query('SiteView')
    query.descending('createdAt')
    
    const latestRecord = await query.first()
    return latestRecord ? latestRecord.get('totalViews') : 0
  }

  // 本地获取网站总访问次数
  getSiteViewsLocal() {
    const siteViews = JSON.parse(localStorage.getItem('site_views') || '{}')
    return Object.values(siteViews)
      .reduce((total, day) => total + day.todayViews, 0)
  }

  // 批量更新处理
  flushUpdates() {
    // 实现批量更新逻辑
    this.updateQueue = []
  }

  // 格式化数字显示
  formatNumber(num) {
    if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'w'
    } else if (num >= 1000) {
      return (num / 1000).toFixed(1) + 'k'
    }
    return num.toLocaleString()
  }
}

// 导出单例
export default new AnalyticsService()
```

### 2.2 创建Vue组件

**创建文件：`vdoing/components/PageViewCounter.vue`**

```vue
<template>
  <div class="page-view-counter" v-if="showViews">
    <i class="iconfont icon-eye"></i>
    <span class="count">{{ formattedViews }}</span>
  </div>
</template>

<script>
import AnalyticsService from '../utils/analytics'

export default {
  name: 'PageViewCounter',
  props: {
    url: {
      type: String,
      required: true
    },
    title: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      views: 0,
      showViews: true
    }
  },
  computed: {
    formattedViews() {
      return AnalyticsService.formatNumber(this.views)
    }
  },
  async mounted() {
    // 检查是否启用统计
    const analyticsConfig = this.$themeConfig.analytics
    if (!analyticsConfig || !analyticsConfig.enable || !analyticsConfig.showPageViews) {
      this.showViews = false
      return
    }

    await this.initAndRecord()
  },
  methods: {
    async initAndRecord() {
      try {
        // 初始化服务
        if (!AnalyticsService.isInitialized) {
          const config = this.$themeConfig.analytics.leancloud
          await AnalyticsService.init(config)
        }

        // 记录访问
        await AnalyticsService.recordPageView(this.url, this.title)
        
        // 获取访问次数
        this.views = await AnalyticsService.getPageViews(this.url)
      } catch (error) {
        console.error('PageViewCounter error:', error)
        this.showViews = false
      }
    }
  }
}
</script>

<style lang="stylus">
.page-view-counter
  display inline-flex
  align-items center
  color var(--text-color-sub)
  font-size 0.85em
  margin-left 10px
  
  .iconfont
    margin-right 3px
    font-size 1em
    
  .count
    font-weight 500
    color var(--accent-color)

@media (max-width: $MQMobile)
  .page-view-counter
    font-size 0.8em
    margin-left 8px
</style>
```

**创建文件：`vdoing/components/SiteViewCounter.vue`**

```vue
<template>
  <div class="site-view-counter" v-if="showViews">
    <div class="stats-item">
      <i class="iconfont icon-eye"></i>
      <span class="label">总访问量</span>
      <span class="count">{{ formattedViews }}</span>
    </div>
  </div>
</template>

<script>
import AnalyticsService from '../utils/analytics'

export default {
  name: 'SiteViewCounter',
  data() {
    return {
      totalViews: 0,
      showViews: true
    }
  },
  computed: {
    formattedViews() {
      return AnalyticsService.formatNumber(this.totalViews)
    }
  },
  async mounted() {
    // 检查是否启用统计
    const analyticsConfig = this.$themeConfig.analytics
    if (!analyticsConfig || !analyticsConfig.enable || !analyticsConfig.showSiteViews) {
      this.showViews = false
      return
    }

    await this.loadSiteViews()
  },
  methods: {
    async loadSiteViews() {
      try {
        // 初始化服务
        if (!AnalyticsService.isInitialized) {
          const config = this.$themeConfig.analytics.leancloud
          await AnalyticsService.init(config)
        }

        this.totalViews = await AnalyticsService.getSiteViews()
      } catch (error) {
        console.error('SiteViewCounter error:', error)
        this.showViews = false
      }
    }
  }
}
</script>

<style lang="stylus">
.site-view-counter
  .stats-item
    display flex
    align-items center
    padding 8px 0
    color var(--text-color)
    
    .iconfont
      margin-right 8px
      color var(--accent-color)
      font-size 1.1em
      
    .label
      flex 1
      font-size 0.9em
      
    .count
      font-weight 600
      color var(--accent-color)
      font-size 1em

@media (max-width: $MQMobile)
  .site-view-counter
    .stats-item
      padding 6px 0
      
      .iconfont
        font-size 1em
        
      .label
        font-size 0.85em
        
      .count
        font-size 0.9em
</style>
```

### 2.3 修改主题文件

**修改文件：`vdoing/components/Page.vue`**

```vue
<!-- 在文章信息区域添加访问统计 -->
<template>
  <main class="page">
    <!-- 文章头部信息 -->
    <div class="page-title" v-if="$page.title">
      <h1>{{ $page.title }}</h1>
      <div class="page-meta" v-if="showPageMeta">
        <ArticleInfo :pageInfo="pageInfo" />
        <!-- 添加页面访问统计 -->
        <PageViewCounter 
          :url="$page.path" 
          :title="$page.title"
        />
      </div>
    </div>
    
    <!-- 文章内容 -->
    <Content class="theme-default-content" />
    
    <!-- 其他组件... -->
  </main>
</template>

<script>
import PageViewCounter from './PageViewCounter.vue'
// ... 其他导入

export default {
  name: 'Page',
  components: {
    PageViewCounter,
    // ... 其他组件
  },
  // ... 其他代码
}
</script>
```

**修改文件：`vdoing/components/BloggerBar.vue`**

```vue
<template>
  <div class="blogger-bar">
    <!-- 博主信息卡片 -->
    <div class="blogger-info">
      <!-- ... 现有博主信息 -->
    </div>
    
    <!-- 网站统计卡片 -->
    <div class="site-stats-card">
      <h4 class="card-title">
        <i class="iconfont icon-chart"></i>
        网站统计
      </h4>
      <div class="stats-content">
        <SiteViewCounter />
        <div class="stats-item">
          <i class="iconfont icon-article"></i>
          <span class="label">文章数量</span>
          <span class="count">{{ articleCount }}</span>
        </div>
        <div class="stats-item">
          <i class="iconfont icon-category"></i>
          <span class="label">分类数量</span>
          <span class="count">{{ categoryCount }}</span>
        </div>
        <div class="stats-item">
          <i class="iconfont icon-tag"></i>
          <span class="label">标签数量</span>
          <span class="count">{{ tagCount }}</span>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import SiteViewCounter from './SiteViewCounter.vue'

export default {
  name: 'BloggerBar',
  components: {
    SiteViewCounter
  },
  computed: {
    articleCount() {
      return this.$site.pages.filter(page => 
        page.path !== '/' && !page.frontmatter.article === false
      ).length
    },
    categoryCount() {
      const categories = new Set()
      this.$site.pages.forEach(page => {
        if (page.frontmatter.categories) {
          page.frontmatter.categories.forEach(cat => categories.add(cat))
        }
      })
      return categories.size
    },
    tagCount() {
      const tags = new Set()
      this.$site.pages.forEach(page => {
        if (page.frontmatter.tags) {
          page.frontmatter.tags.forEach(tag => tags.add(tag))
        }
      })
      return tags.size
    }
  }
}
</script>

<style lang="stylus">
.site-stats-card
  background var(--background-color)
  border-radius 8px
  padding 16px
  margin-top 16px
  box-shadow var(--box-shadow)
  
  .card-title
    display flex
    align-items center
    margin 0 0 12px 0
    font-size 1em
    font-weight 600
    color var(--text-color)
    
    .iconfont
      margin-right 6px
      color var(--accent-color)
      
  .stats-content
    .stats-item
      display flex
      align-items center
      padding 6px 0
      color var(--text-color-sub)
      
      .iconfont
        margin-right 8px
        color var(--accent-color)
        font-size 1em
        width 16px
        
      .label
        flex 1
        font-size 0.9em
        
      .count
        font-weight 600
        color var(--accent-color)
        font-size 0.95em
</style>
```

## 3. 配置文件设置

**修改文件：`docs/.vuepress/config.ts`**

```typescript
export default defineConfig4CustomTheme<VdoingThemeConfig>({
  // ... 其他配置
  
  themeConfig: {
    // ... 其他主题配置
    
    // 访问统计配置
    analytics: {
      enable: true,                    // 启用访问统计
      provider: 'leancloud',          // 使用LeanCloud作为数据存储
      leancloud: {
        appId: process.env.VUE_APP_LEANCLOUD_APP_ID || 'your-app-id',
        appKey: process.env.VUE_APP_LEANCLOUD_APP_KEY || 'your-app-key',
        serverURL: process.env.VUE_APP_LEANCLOUD_SERVER_URL || 'https://your-domain.lc-cn-n1-shared.com'
      },
      // 显示配置
      showSiteViews: true,            // 在侧边栏显示网站总访问量
      showPageViews: true,            // 在文章页显示文章访问量
      // 防刷配置
      cooldown: 300000,               // 5分钟冷却时间（毫秒）
      enableLocalFallback: true       // 启用本地存储降级
    }
  }
})
```

**创建环境变量文件：`.env.local`**

```bash
# LeanCloud配置
VUE_APP_LEANCLOUD_APP_ID=your-leancloud-app-id
VUE_APP_LEANCLOUD_APP_KEY=your-leancloud-app-key
VUE_APP_LEANCLOUD_SERVER_URL=https://your-domain.lc-cn-n1-shared.com
```

## 4. 样式和图标配置

**修改文件：`vdoing/styles/index.styl`**

```stylus
// 访问统计相关样式
.page-view-counter,
.site-view-counter
  transition all 0.3s ease
  
  &:hover
    transform translateY(-1px)
    
// 统计卡片样式
.site-stats-card
  border 1px solid var(--border-color)
  transition all 0.3s ease
  
  &:hover
    box-shadow var(--box-shadow-hover)
    
// 响应式适配
@media (max-width: $MQMobile)
  .site-stats-card
    margin-top 12px
    padding 12px
    
    .card-title
      font-size 0.9em
      margin-bottom 10px
```

**添加图标字体（如果使用iconfont）**

在 `docs/.vuepress/config.ts` 中添加：

```typescript
head: [
  // ... 其他head配置
  
  // 添加iconfont图标库
  ['link', { 
    rel: 'stylesheet', 
    href: '//at.alicdn.com/t/font_3114978_qe0b39no76.css' 
  }]
]
```

## 5. 部署和测试

### 5.1 本地测试

```bash
# 启动开发服务器
npm run dev

# 检查控制台是否有错误
# 访问文章页面，查看访问统计是否正常显示
# 刷新页面，检查访问次数是否增加
```

### 5.2 生产部署

```bash
# 构建生产版本
npm run build

# 部署到服务器
npm run deploy
```

### 5.3 功能验证

1. **访问统计功能**
   - 访问不同文章，检查访问次数是否正确记录
   - 检查网站总访问量是否正确累加
   - 验证5分钟防刷机制是否生效

2. **降级机制**
   - 断开网络连接，检查是否降级到本地存储
   - 恢复网络后，检查数据是否正常同步

3. **性能测试**
   - 检查页面加载速度是否受影响
   - 验证统计组件是否异步加载

## 6. 故障排除

### 6.1 常见问题

**问题1：LeanCloud连接失败**
```bash
# 检查配置是否正确
console.log(process.env.VUE_APP_LEANCLOUD_APP_ID)

# 检查网络连接
# 检查LeanCloud服务状态
```

**问题2：访问次数不增加**
```javascript
// 检查防刷机制
// 清除localStorage缓存
localStorage.removeItem('page_views')
localStorage.removeItem('site_views')
```

**问题3：组件不显示**
```javascript
// 检查主题配置
console.log(this.$themeConfig.analytics)

// 检查组件注册
// 检查CSS样式
```

### 6.2 调试工具

```javascript
// 在浏览器控制台中调试
window.AnalyticsService = AnalyticsService

// 查看缓存数据
console.log(AnalyticsService.cache)

// 手动触发统计
AnalyticsService.recordPageView('/test', 'Test Page')
```

## 7. 维护和优化

### 7.1 数据备份

```javascript
// 定期导出LeanCloud数据
// 可以通过LeanCloud控制台或API导出
```

### 7.2 性能监控

```javascript
// 添加性能监控
const startTime = performance.now()
// ... 统计操作
const endTime = performance.now()
console.log(`Analytics operation took ${endTime - startTime} milliseconds`)
```

### 7.3 扩展功能

- 添加访问来源统计
- 实现热门文章排行
- 添加访问趋势图表
- 集成Google Analytics

通过以上实施指南，您可以成功为VuePress博客系统添加完整的访问统计功能。